<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>사잇길 관리자 - Say It Gil Hotel</title>
    <link rel="stylesheet" href="assets/css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    
  </head>
  <body>
    <header class="header">
      <div class="nav-container">
        <a href="index.html" class="logo">사잇길 관리자</a>

        <!-- 내비게이션 -->
        <nav class="nav">
          <ul class="nav-links">
            <li><a href="index.html">메인 사이트</a></li>
            <li><a href="reservation.html">예약 페이지</a></li>
          </ul>
        </nav>

        

        <!-- 햄버거 메뉴 -->
        <div class="hamburger">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
    </header>

    <main class="admin-container">
      <section class="section login-section">
        <div class="container">
          <h1 class="section-title">관리자 로그인</h1>
          <p class="section-subtitle">Say It Gil Hotel 관리자 페이지에 접속하세요</p>

          <div class="login-form-container">
            <form id="loginForm" class="login-form">
              <div class="form-group">
                <label for="adminEmail">
                  <i class="fas fa-envelope"></i>
                </label>
                <input
                  type="email"
                  id="adminEmail"
                  name="adminEmail"
                  placeholder="관리자 이메일을 입력하세요"
                  required
                />
              </div>

              <div class="form-group">
                <label for="adminPassword">
                  <i class="fas fa-lock"></i>
                </label>
                <input
                  type="password"
                  id="adminPassword"
                  name="adminPassword"
                  placeholder="비밀번호를 입력하세요"
                  required
                />
              </div>

              <button type="submit" class="login-btn">
                <i class="fas fa-sign-in-alt"></i>
                로그인
              </button>
            </form>
          </div>
        </div>
      </section>

      <section id="adminPanel" class="section admin-panel-section hidden">
        <div class="container">
          <div class="admin-header">
            <div>
              <h2 class="section-title">막걸리 체험 관리자 대시보드</h2>
              <div class="admin-id-display">
                관리자 ID: <span id="adminUserId">-</span>
              </div>
            </div>
            <div style="display: flex; gap: 1rem; align-items: center">
              <div class="status-filter-container">
                <button class="status-filter-btn" onclick="toggleStatusDropdown()">상태 필터</button>
                <div class="status-dropdown" id="statusDropdown">
                  <button
                    class="active" onclick="filterByStatus('all')">전체 보기</button>
                  <button
                    onclick="filterByStatus('pending')">입금/확정 대기</button>
                  <button
                    onclick="filterByStatus('confirmed')">예약 확정</button>
                  <button
                    onclick="filterByStatus('cancelled')">예약 취소</button>
                </div>
              </div>
              <button onclick="logout()" class="logout-btn">
                <i class="fas fa-sign-out-alt"></i>
                로그아웃
              </button>
            </div>
          </div>

          <div class="admin-stats">
            <div class="stat-card">
              <div class="stat-icon">
                <i class="fas fa-calendar-check"></i>
              </div>
              <div class="stat-info">
                <h3 id="totalReservations">0</h3>
                <p data-i18n="stat_total_reservations">총 예약 수</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">
                <i class="fas fa-users"></i>
              </div>
              <div class="stat-info">
                <h3 id="totalGuests">0</h3>
                <p data-i18n="stat_total_guests">총 고객 수</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">
                <i class="fas fa-bed"></i>
              </div>
              <div class="stat-info">
                <h3 id="activeReservations">0</h3>
                <p data-i18n="stat_active_reservations">활성 예약</p>
              </div>
            </div>
          </div>

          <!-- 체험 정원 관리 섹션 -->
          <div class="admin-table-container">
            <div class="table-header">
              <h3>체험 정원 관리</h3>
              <button onclick="openScheduleModal()" class="refresh-btn">
                <i class="fas fa-plus"></i>
                정원 추가
              </button>
              <button
                id="bulkGenerateBtn"
                onclick="openBulkModal()"
                class="refresh-btn"
                title="특정 기간 동안 (매일 18:00, 정원 40) 일괄 생성"
              >
                <i class="fas fa-calendar-plus"></i>
                기간 생성
              </button>
            </div>

            <div class="table-wrapper">
              <table class="admin-table">
                <thead>
                  <tr>
                    <th>날짜</th>
                    <th>시간</th>
                    <th>최대 정원</th>
                    <th>예약 인원</th>
                    <th>남은 정원</th>
                    <th>관리</th>
                  </tr>
                </thead>
                <tbody id="scheduleTable"></tbody>
              </table>
            </div>
            <div id="schedulePagination" class="pagination"></div>
          </div>

          <!-- 예약 현황 섹션 -->
          <div class="admin-table-container" style="margin-top: 2rem">
            <div class="table-header">
              <h3>예약 현황</h3>
              <div class="table-controls">
                <input
                  type="text"
                  id="searchInput"
                  placeholder="이름, 이메일로 검색..."
                  class="search-input"
                />
                <button onclick="refreshData()" class="refresh-btn">
                  <i class="fas fa-sync-alt"></i>
                  새로고침
                </button>
              </div>
            </div>

            <div class="table-wrapper">
              <table class="admin-table">
                <thead>
                  <tr>
                    <th>예약자명</th>
                    <th>시간</th>
                    <th>인원/금액</th>
                    <th>상태</th>
                    <th>연락처</th>
                    <th>관리</th>
                  </tr>
                </thead>
                <tbody id="adminTable"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- 정원 추가/수정 모달 -->
    <div id="scheduleModal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="modalTitle">체험 정원 추가</h3>
          <button onclick="closeScheduleModal()" class="modal-close">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form id="scheduleForm" class="modal-form">
          <div class="form-group">
            <label for="scheduleDate" class="required">체험 날짜</label>
            <input type="date" id="scheduleDate" name="scheduleDate" required />
          </div>
          <div class="form-group">
            <label for="scheduleTime" class="required">체험 시간</label>
            <select id="scheduleTime" name="scheduleTime" required>
              <option value="">시간을 선택하세요</option>
              <option value="18:00">18:00</option>
            </select>
          </div>
          <div class="form-group">
            <label for="maxCapacity" class="required">최대 정원</label>
            <input
              type="number"
              id="maxCapacity"
              name="maxCapacity"
              min="1"
              max="50"
              required
            />
          </div>
          <div class="modal-actions">
            <button type="button" onclick="closeScheduleModal()" class="btn-cancel">취소</button>
            <button type="submit" class="booking-btn">저장</button>
          </div>
        </form>
      </div>
    </div>

    <!-- 기간 일괄 생성 모달 -->
    <div id="bulkModal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3>기간별 스케줄 생성</h3>
          <button onclick="closeBulkModal()" class="modal-close">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form id="bulkForm" class="modal-form">
          <div class="form-group">
            <label for="bulkStart" class="required">시작 날짜</label>
            <input type="date" id="bulkStart" name="bulkStart" required />
          </div>
          <div class="form-group">
            <label for="bulkEnd" class="required">종료 날짜</label>
            <input type="date" id="bulkEnd" name="bulkEnd" required />
          </div>
          <div class="form-group">
            <label for="bulkTime" class="required">체험 시간</label>
            <select id="bulkTime" name="bulkTime" required>
              <option value="">시간을 선택하세요</option>
              <option value="18:00">18:00</option>
            </select>
          </div>
          <div class="form-group">
            <label for="bulkCapacity" class="required">최대 정원</label>
            <input
              type="number"
              id="bulkCapacity"
              name="bulkCapacity"
              min="1"
              max="50"
              value="40"
              required
            />
          </div>
          <div class="modal-actions">
            <button type="button" onclick="closeBulkModal()" class="btn-cancel">
              취소
            </button>
            <button type="submit" class="booking-btn">생성</button>
          </div>
        </form>
      </div>
    </div>

    <footer class="footer">
      <div class="container">
        <div class="footer-content">
          <div class="footer-logo">Say It Gil Hotel 관리자</div>
          <div class="footer-links">
            <a href="index.html">메인 사이트</a> |
            <a href="reservation.html">예약 페이지</a>
          </div>
        </div>
        <p class="copyright">
          &copy; 2025 Say It Gil Hotel. All Rights Reserved.
        </p>
      </div>
    </footer>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        deleteDoc,
        doc,
        updateDoc,
        addDoc,
        query,
        where,
      } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
      import {
        getAuth,
        signInWithEmailAndPassword,
        signOut,
      } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

      // 헤더 여백 조정
      const headerEl = document.querySelector(".header");
      const contentEl = document.querySelector(".admin-container");
      if (headerEl && contentEl)
        contentEl.style.paddingTop = headerEl.offsetHeight + 20 + "px";

      // Firebase 설정
      const firebaseConfig = {
        apiKey: "AIzaSyBcxmh2FQ8-1J8yk816XZJyiEAn-_z1Ufc",
        authDomain: "sayitgil-reservation.firebaseapp.com",
        projectId: "sayitgil-reservation",
        storageBucket: "sayitgil-reservation.appspot.com",
        messagingSenderId: "156182422109",
        appId: "1:156182422109:web:71e9b0948331f1755123b4",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      // UI 요소들
      const loginForm = document.getElementById("loginForm");
      const adminPanel = document.getElementById("adminPanel");
      const tableBody = document.getElementById("adminTable");
      const scheduleTable = document.getElementById("scheduleTable");
      const schedulePaginationEl =
        document.getElementById("schedulePagination");
      const searchInput = document.getElementById("searchInput");
      const totalReservations = document.getElementById("totalReservations");
      const totalGuests = document.getElementById("totalGuests");
      const activeReservations = document.getElementById("activeReservations");
      const adminUserId = document.getElementById("adminUserId");
      const scheduleModal = document.getElementById("scheduleModal");
      const scheduleForm = document.getElementById("scheduleForm");
      const bulkGenerateBtn = document.getElementById("bulkGenerateBtn");
      const bulkModal = document.getElementById("bulkModal");
      const bulkForm = document.getElementById("bulkForm");

      let allReservations = [];
      let allSchedules = [];
      let currentStatusFilter = "all";
      let editingScheduleId = null;
      let scheduleCurrentPage = 1;
      const scheduleItemsPerPage = 7;

      // 로그인 처리
      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const loginBtn = loginForm.querySelector('button[type="submit"]');
        const originalText = loginBtn.innerHTML;

        try {
          loginBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> 로그인 중...';
          loginBtn.disabled = true;

          const userCredential = await signInWithEmailAndPassword(
            auth,
            loginForm.adminEmail.value,
            loginForm.adminPassword.value
          );

          // 관리자 ID 표시
          adminUserId.textContent = userCredential.user.uid;

          loginForm.classList.add("hidden");
          adminPanel.classList.remove("hidden");
          await loadReservations();
          await loadSchedules();
        } catch (error) {
          alert("로그인 실패: " + error.message);
        } finally {
          loginBtn.innerHTML = originalText;
          loginBtn.disabled = false;
        }
      });

      // 로그아웃 처리
      window.logout = async () => {
        try {
          await signOut(auth);
          loginForm.classList.remove("hidden");
          adminPanel.classList.add("hidden");
          loginForm.reset();
        } catch (error) {
          console.error("로그아웃 오류:", error);
        }
      };

      // 예약 데이터 로드
      async function loadReservations() {
        try {
          const snapshot = await getDocs(collection(db, "reservations"));
          allReservations = [];

          snapshot.forEach((docSnap) => {
            const data = docSnap.data();
            allReservations.push({
              id: docSnap.id,
              ...data,
            });
          });

          updateStats();
          displayReservations(getFilteredReservations());
        } catch (error) {
          console.error("데이터 로드 오류:", error);
          alert("데이터를 불러오는 중 오류가 발생했습니다.");
        }
      }

      // 스케줄 로드
      async function loadSchedules() {
        try {
          const snap = await getDocs(collection(db, "experienceSchedules"));
          allSchedules = [];
          snap.forEach((docSnap) => {
            const d = docSnap.data();
            allSchedules.push({ id: docSnap.id, ...d });
          });
          scheduleCurrentPage = 1;
          renderSchedules();
        } catch (e) {
          console.error("스케줄 로드 오류:", e);
        }
      }

      // 스케줄 테이블 렌더링 (예약 인원/잔여석 계산 포함)
      function renderSchedules() {
        scheduleTable.innerHTML = "";
        if (allSchedules.length === 0) {
          scheduleTable.innerHTML = `
            <tr>
              <td colspan="6" class="no-data">등록된 스케줄이 없습니다.</td>
            </tr>
          `;
          if (schedulePaginationEl) schedulePaginationEl.innerHTML = "";
          return;
        }

        // 스케줄별 예약 인원 집계
        const countByKey = new Map();
        for (const r of allReservations) {
          if (r.type !== "experience") continue;
          const key = `${r.experienceDate}__${r.experienceTime}`;
          const val = countByKey.get(key) || 0;
          countByKey.set(key, val + (Number(r.participants) || 0));
        }

        // 날짜/시간 순 정렬
        const sorted = [...allSchedules].sort((a, b) => {
          if (a.date === b.date)
            return (a.time || "").localeCompare(b.time || "");
          return (a.date || "").localeCompare(b.date || "");
        });

        // 페이지네이션 계산
        const totalPages = Math.max(
          1,
          Math.ceil(sorted.length / scheduleItemsPerPage)
        );
        if (scheduleCurrentPage > totalPages) scheduleCurrentPage = totalPages;
        const startIdx = (scheduleCurrentPage - 1) * scheduleItemsPerPage;
        const endIdx = startIdx + scheduleItemsPerPage;
        const pageItems = sorted.slice(startIdx, endIdx);

        for (const s of pageItems) {
          const key = `${s.date}__${s.time}`;
          const booked = countByKey.get(key) || 0;
          const remaining = Math.max(0, (Number(s.maxCapacity) || 0) - booked);

          const tr = document.createElement("tr");
          if (remaining === 0) tr.classList.add("row-disabled");
          tr.innerHTML = `
            <td>${s.date || "-"}</td>
            <td>${s.time || "-"}</td>
            <td>${s.maxCapacity || 0}</td>
            <td>${booked}</td>
            <td>${remaining}</td>
            <td class="action-buttons">
              <button class="btn-edit" title="수정" onclick="openScheduleModal('${
                s.id
              }')">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-delete" title="삭제" onclick="deleteSchedule('${
                s.id
              }')">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          `;
          scheduleTable.appendChild(tr);
        }

        // 페이지네이션 렌더링
        if (!schedulePaginationEl) return;
        if (totalPages <= 1) {
          schedulePaginationEl.innerHTML = "";
          return;
        }
        let html = "";
        const prevDisabled = scheduleCurrentPage === 1 ? "disabled" : "";
        const nextDisabled =
          scheduleCurrentPage === totalPages ? "disabled" : "";
        // 처음, 이전
        html += `<button class=\"refresh-btn\" ${prevDisabled} onclick=\"goToSchedulePage(1)\">&laquo;</button>`;
        html += `<button class=\"refresh-btn\" ${prevDisabled} onclick=\"goToSchedulePage(${Math.max(
          1,
          scheduleCurrentPage - 1
        )})\">이전</button>`;
        // 최대 7개 숫자 버튼 윈도우
        const maxButtons = 7;
        let startPage = Math.max(
          1,
          scheduleCurrentPage - Math.floor(maxButtons / 2)
        );
        let endPage = startPage + maxButtons - 1;
        if (endPage > totalPages) {
          endPage = totalPages;
          startPage = Math.max(1, endPage - maxButtons + 1);
        }
        for (let p = startPage; p <= endPage; p++) {
          const activeClass = p === scheduleCurrentPage ? "active" : "";
          html += `<button class=\"refresh-btn ${activeClass}\" onclick=\"goToSchedulePage(${p})\">${p}</button>`;
        }
        // 다음, 마지막
        html += `<button class=\"refresh-btn\" ${nextDisabled} onclick=\"goToSchedulePage(${Math.min(
          totalPages,
          scheduleCurrentPage + 1
        )})\">다음</button>`;
        html += `<button class=\"refresh-btn\" ${nextDisabled} onclick=\"goToSchedulePage(${totalPages})\">&raquo;</button>`;
        schedulePaginationEl.innerHTML = html;
      }

      // 모달 열기/닫기
      window.openScheduleModal = (id = null) => {
        editingScheduleId = id;
        const title = document.getElementById("modalTitle");
        const dateEl = document.getElementById("scheduleDate");
        const timeEl = document.getElementById("scheduleTime");
        const capEl = document.getElementById("maxCapacity");

        if (id) {
          const found = allSchedules.find((s) => s.id === id);
          if (found) {
            title.textContent = "체험 정원 수정";
            dateEl.value = found.date || "";
            timeEl.value = found.time || "";
            capEl.value = found.maxCapacity || 0;
          }
        } else {
          title.textContent = "체험 정원 추가";
          dateEl.value = "";
          timeEl.value = "18:00";
          capEl.value = "";
        }
        scheduleModal.classList.remove("hidden");
      };

      window.closeScheduleModal = () => {
        scheduleModal.classList.add("hidden");
      };

      // 기간 생성 모달 열기/닫기
      window.openBulkModal = () => {
        const start = document.getElementById("bulkStart");
        const end = document.getElementById("bulkEnd");
        const time = document.getElementById("bulkTime");
        const cap = document.getElementById("bulkCapacity");
        const today = new Date();
        const pad2 = (n) => (n < 10 ? `0${n}` : `${n}`);
        const fmt = (d) =>
          `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
        start.value = fmt(today);
        end.value = fmt(
          new Date(today.getFullYear(), today.getMonth(), today.getDate())
        );
        time.value = "18:00";
        cap.value = 40;
        bulkModal.classList.remove("hidden");
      };
      window.closeBulkModal = () => {
        bulkModal.classList.add("hidden");
      };

      // 스케줄 페이지 이동
      window.goToSchedulePage = (page) => {
        const totalPages = Math.max(
          1,
          Math.ceil(allSchedules.length / scheduleItemsPerPage)
        );
        const next = Math.min(Math.max(1, Number(page) || 1), totalPages);
        scheduleCurrentPage = next;
        renderSchedules();
      };

      // 스케줄 저장 (추가/수정)
      scheduleForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const date = (
          document.getElementById("scheduleDate").value || ""
        ).trim();
        const time = (
          document.getElementById("scheduleTime").value || ""
        ).trim();
        const maxCapacity = Number(
          document.getElementById("maxCapacity").value || 0
        );
        if (!date || !time || !maxCapacity || maxCapacity <= 0) {
          alert("모든 값을 올바르게 입력해주세요.");
          return;
        }

        try {
          if (editingScheduleId) {
            await updateDoc(doc(db, "experienceSchedules", editingScheduleId), {
              date,
              time,
              maxCapacity,
            });
          } else {
            await addDoc(collection(db, "experienceSchedules"), {
              date,
              time,
              maxCapacity,
              createdAt: new Date().toISOString(),
            });
          }
          await loadSchedules();
          closeScheduleModal();
        } catch (e) {
          console.error("스케줄 저장 오류:", e);
          alert("저장 중 오류가 발생했습니다.");
        }
      });

      // 기간별 스케줄 일괄 생성 (유동 범위, 지정 시간/정원)
      bulkForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const startStr = (
          document.getElementById("bulkStart").value || ""
        ).trim();
        const endStr = (document.getElementById("bulkEnd").value || "").trim();
        const time = (document.getElementById("bulkTime").value || "").trim();
        const cap = Number(document.getElementById("bulkCapacity").value || 0);
        if (!startStr || !endStr || !time || !cap || cap <= 0) {
          alert("모든 값을 올바르게 입력해주세요.");
          return;
        }
        if (endStr < startStr) {
          alert("종료 날짜가 시작 날짜보다 빠릅니다.");
          return;
        }
        try {
          const confirmMsg = `${startStr} ~ ${endStr} 기간에 매일 ${time}, 정원 ${cap}명 스케줄을 생성할까요?\n이미 있는 동일 시간 스케줄은 건너뜁니다.`;
          if (!confirm(confirmMsg)) return;
          if (bulkGenerateBtn) {
            bulkGenerateBtn.disabled = true;
            bulkGenerateBtn.innerHTML =
              '<i class="fas fa-spinner fa-spin"></i> 생성 중...';
          }
          // 기존 스케줄 조회 (date 범위)
          const snap = await getDocs(
            query(
              collection(db, "experienceSchedules"),
              where("date", ">=", startStr),
              where("date", "<=", endStr)
            )
          );
          const existing = new Set();
          snap.forEach((docSnap) => {
            const d = docSnap.data();
            if (d && d.date && d.time) existing.add(`${d.date}__${d.time}`);
          });
          // 날짜 루프
          const [sy, sm, sd] = startStr.split("-").map((v) => Number(v));
          const [ey, em, ed] = endStr.split("-").map((v) => Number(v));
          const start = new Date(sy, sm - 1, sd);
          const end = new Date(ey, em - 1, ed);
          const pad2 = (n) => (n < 10 ? `0${n}` : `${n}`);
          const fmt = (d) =>
            `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
          const targets = [];
          for (
            let cur = new Date(start.getTime());
            cur.getTime() <= end.getTime();
            cur.setDate(cur.getDate() + 1)
          ) {
            const ds = fmt(cur);
            const key = `${ds}__${time}`;
            if (!existing.has(key)) targets.push(ds);
          }
          if (targets.length === 0) {
            alert("추가할 스케줄이 없습니다.");
            return;
          }
          // 순차 생성
          for (const ds of targets) {
            await addDoc(collection(db, "experienceSchedules"), {
              date: ds,
              time,
              maxCapacity: cap,
              createdAt: new Date().toISOString(),
            });
          }
          alert(`${targets.length}개의 스케줄을 생성했습니다.`);
          closeBulkModal();
          await loadSchedules();
        } catch (e) {
          console.error("기간 일괄 생성 오류:", e);
          alert("일괄 생성 중 오류가 발생했습니다.");
        } finally {
          if (bulkGenerateBtn) {
            bulkGenerateBtn.disabled = false;
            bulkGenerateBtn.innerHTML =
              '<i class="fas fa-calendar-plus"></i> 기간 생성';
          }
        }
      });

      // 스케줄 삭제
      window.deleteSchedule = async (id) => {
        if (!confirm("정말 삭제하시겠습니까?")) return;
        try {
          await deleteDoc(doc(db, "experienceSchedules", id));
          await loadSchedules();
        } catch (e) {
          console.error("스케줄 삭제 오류:", e);
          alert("삭제 중 오류가 발생했습니다.");
        }
      };

      // 통계 업데이트 (숙소/체험 예약 둘 다 대응)
      function updateStats() {
        // 취소되지 않은 예약만 카운트
        const activeBookings = allReservations.filter(
          (res) => res.status !== "cancelled"
        );

        const total = activeBookings.length;
        const guests = activeBookings.reduce((sum, res) => {
          const cnt =
            res.type === "experience" ? res.participants || 0 : res.guests || 0;
          return sum + Number(cnt || 0);
        }, 0);

        const today = new Date().toISOString().split("T")[0];
        const active = activeBookings.filter((res) => {
          if (res.type === "experience")
            return (res.experienceDate || "") >= today;
          return (res.checkout || "") >= today;
        }).length;

        totalReservations.textContent = total;
        totalGuests.textContent = guests;
        activeReservations.textContent = active;
      }

      // 예약 목록 표시 (숙소/체험 공용)
      function displayReservations(reservations) {
        tableBody.innerHTML = "";

        if (reservations.length === 0) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="6" class="no-data">
                현재 예약이 없습니다.
              </td>
            </tr>
          `;
          return;
        }

        reservations.forEach((rsv) => {
          const isExp = rsv.type === "experience";
          const name = isExp ? rsv.repName || "-" : rsv.name || "-";
          const subTitle = isExp
            ? rsv.experienceTitle || "체험 예약"
            : rsv.roomTitle || "-";

          let timeHtml = "-";
          if (isExp) {
            timeHtml = `<div>${
              rsv.experienceDate || "-"
            }</div><div style="font-size: 0.85rem; color: #666;">${
              rsv.experienceTime || "-"
            }</div>`;
          } else {
            timeHtml = `<div>${
              rsv.checkin || "-"
            }</div><div style=\"font-size: 0.85rem; color: #666;\">~ ${
              rsv.checkout || "-"
            }</div>`;
          }

          const people = isExp ? rsv.participants || "-" : rsv.guests || "-";

          const status = rsv.status || "pending";
          const statusText =
            {
              pending: "입금/확정 대기",
              confirmed: "예약 확정",
              cancelled: "예약 취소",
            }[status] || "입금/확정 대기";

          const email = isExp ? rsv.repEmail || "-" : rsv.email || "-";
          const phone = isExp ? rsv.repPhone || "-" : rsv.phone || "-";

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>
              <div><strong>${name}</strong></div>
              <div style="font-size: 0.85rem; color: #666;">${subTitle}</div>
            </td>
            <td>${timeHtml}</td>
            <td><div>${people}명</div></td>
            <td><span class="status-badge ${status}">${statusText}</span></td>
            <td>
              <div>${email}</div>
              <div style="font-size: 0.85rem; color: #666;">${phone}</div>
              ${
                !isExp && rsv.whatsapp
                  ? `<div style="font-size: 0.85rem; color: #666;">WhatsApp: ${rsv.whatsapp}</div>`
                  : ""
              }
            </td>
            <td class="action-buttons">
              <button class="btn-edit" onclick="editReservation('${
                rsv.id
              }')" title="예약 확정">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-delete" onclick="deleteReservation('${
                rsv.id
              }')" title="예약 취소">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          `;
          tableBody.appendChild(row);
        });
      }

      // 상태 필터링 함수 (숙소/체험 공용 검색)
      function getFilteredReservations() {
        const searchTerm = searchInput.value.toLowerCase();
        return allReservations.filter((r) => {
          const statusMatch =
            currentStatusFilter === "all" ||
            (r.status || "pending") === currentStatusFilter;
          const nameMatch =
            (r.name && r.name.toLowerCase().includes(searchTerm)) ||
            (r.repName && r.repName.toLowerCase().includes(searchTerm));
          const emailMatch =
            (r.email && r.email.toLowerCase().includes(searchTerm)) ||
            (r.repEmail && r.repEmail.toLowerCase().includes(searchTerm));
          const searchMatch = !searchTerm || nameMatch || emailMatch;
          return statusMatch && searchMatch;
        });
      }

      // 검색 기능
      searchInput.addEventListener("input", (e) => {
        displayReservations(getFilteredReservations());
      });

      // 새로고침 기능
      window.refreshData = async () => {
        await loadReservations();
      };

      // 상태 필터 드롭다운 토글
      window.toggleStatusDropdown = () => {
        const dropdown = document.getElementById("statusDropdown");
        dropdown.classList.toggle("show");
      };

      // 드롭다운 외부 클릭 시 닫기
      document.addEventListener("click", (e) => {
        const container = document.querySelector(".status-filter-container");
        const dropdown = document.getElementById("statusDropdown");
        if (container && !container.contains(e.target)) {
          dropdown?.classList.remove("show");
        }
      });

      // 상태 필터 선택
      window.filterByStatus = (status) => {
        currentStatusFilter = status;

        // 드롭다운 버튼의 active 클래스 업데이트
        const dropdown = document.getElementById("statusDropdown");
        const buttons = dropdown.querySelectorAll("button");
        buttons.forEach((btn) => {
          btn.classList.remove("active");
          if (
            (status === "all" && btn.textContent === "전체 보기") ||
            (status === "pending" && btn.textContent === "입금/확정 대기") ||
            (status === "confirmed" && btn.textContent === "예약 확정") ||
            (status === "cancelled" && btn.textContent === "예약 취소")
          ) {
            btn.classList.add("active");
          }
        });

        // 드롭다운 닫기
        dropdown.classList.remove("show");

        // 필터링된 결과 표시
        displayReservations(getFilteredReservations());
      };

      // 예약 수정 (상태 + 기본 정보 수정)
      window.editReservation = async (id) => {
        try {
          const r = allReservations.find((x) => x.id === id);
          if (!r) {
            alert("예약 정보를 찾을 수 없습니다.");
            return;
          }

          const statusOptions = {
            pending: "입금/확정 대기",
            confirmed: "예약 확정",
            cancelled: "예약 취소",
          };

          const isExp = r.type === "experience";

          if (isExp) {
            // 체험 예약 편집
            const repName = prompt("예약자명", r.repName || "");
            if (repName === null) return;
            const repEmail = prompt("이메일", r.repEmail || "");
            if (repEmail === null) return;
            const repPhone = prompt("연락처", r.repPhone || "");
            if (repPhone === null) return;
            const experienceDate = prompt(
              "체험 날짜 (YYYY-MM-DD)",
              r.experienceDate || ""
            );
            if (experienceDate === null) return;
            const experienceTime = prompt(
              "체험 시간 (HH:mm)",
              r.experienceTime || ""
            );
            if (experienceTime === null) return;
            const participantsStr = prompt(
              "참가 인원",
              String(r.participants || "")
            );
            if (participantsStr === null) return;
            const participants = Number(participantsStr);
            if (Number.isNaN(participants) || participants <= 0) {
              alert("인원 수는 1 이상의 숫자여야 합니다.");
              return;
            }

            // 상태 변경
            const currentStatus = r.status || "pending";
            let statusChoice = prompt(
              `현재 상태: ${statusOptions[currentStatus]}\n\n상태를 변경하시겠습니까?\n1: 입금/확정 대기\n2: 예약 확정\n3: 예약 취소\n\n번호를 입력하세요 (취소하려면 취소 클릭):`,
              currentStatus === "pending"
                ? "1"
                : currentStatus === "confirmed"
                ? "2"
                : "3"
            );
            if (statusChoice === null) return;
            let status = currentStatus;
            if (statusChoice === "1") status = "pending";
            else if (statusChoice === "2") status = "confirmed";
            else if (statusChoice === "3") status = "cancelled";
            else {
              alert("올바른 번호를 입력해주세요.");
              return;
            }

            const pricePerPerson = Number(r.pricePerPerson || 40000);
            const totalAmount = pricePerPerson * participants;

            await updateDoc(doc(db, "reservations", id), {
              repName,
              repEmail,
              repPhone,
              experienceDate,
              experienceTime,
              participants,
              pricePerPerson,
              totalAmount,
              status,
            });
          } else {
            // 숙소 예약 편집
            const name = prompt("예약자명", r.name || "");
            if (name === null) return;
            const email = prompt("이메일", r.email || "");
            if (email === null) return;
            const phone = prompt("연락처", r.phone || "");
            if (phone === null) return;
            const whatsapp = prompt("WhatsApp ID", r.whatsapp || "");
            if (whatsapp === null) return;
            const checkin = prompt("체크인 (YYYY-MM-DD)", r.checkin || "");
            if (checkin === null) return;
            const checkout = prompt("체크아웃 (YYYY-MM-DD)", r.checkout || "");
            if (checkout === null) return;
            if (checkin && checkout && checkout <= checkin) {
              alert(
                "체크아웃 날짜가 체크인보다 같거나 이릅니다. 다시 확인해주세요."
              );
              return;
            }
            const guestsStr = prompt("인원 수", String(r.guests || ""));
            if (guestsStr === null) return;
            const guests = Number(guestsStr);
            if (Number.isNaN(guests) || guests <= 0) {
              alert("인원 수는 1 이상의 숫자여야 합니다.");
              return;
            }

            const currentStatus = r.status || "pending";
            let statusChoice = prompt(
              `현재 상태: ${statusOptions[currentStatus]}\n\n상태를 변경하시겠습니까?\n1: 입금/확정 대기\n2: 예약 확정\n3: 예약 취소\n\n번호를 입력하세요 (취소하려면 취소 클릭):`,
              currentStatus === "pending"
                ? "1"
                : currentStatus === "confirmed"
                ? "2"
                : "3"
            );
            if (statusChoice === null) return;
            let status = currentStatus;
            if (statusChoice === "1") status = "pending";
            else if (statusChoice === "2") status = "confirmed";
            else if (statusChoice === "3") status = "cancelled";
            else {
              alert("올바른 번호를 입력해주세요.");
              return;
            }

            await updateDoc(doc(db, "reservations", id), {
              name,
              email,
              emailLower: email.toLowerCase(),
              phone,
              whatsapp,
              checkin,
              checkout,
              guests,
              status,
            });
          }

          alert("예약 정보가 수정되었습니다.");
          await loadReservations();
          await loadSchedules();
        } catch (err) {
          console.error("수정 오류:", err);
          alert("수정 중 오류가 발생했습니다.");
        }
      };

      // 예약 삭제
      window.deleteReservation = async (id) => {
        if (!confirm("정말 삭제하시겠습니까?")) return;
        try {
          await deleteDoc(doc(db, "reservations", id));
          alert("예약이 삭제되었습니다.");
          await loadReservations();
        } catch (err) {
          console.error("삭제 오류:", err);
          alert("삭제 중 오류가 발생했습니다.");
        }
      };
    </script>
  </body>
</html>
