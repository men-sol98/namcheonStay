<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>사잇길 관리자 - Say It Gil Hotel</title>
    <link rel="stylesheet" href="assets/css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <header class="header">
      <div class="nav-container">
        <a href="index.html" class="logo">사잇길 관리자</a>

        <!-- 내비게이션 -->
        <nav class="nav">
          <ul class="nav-links">
            <li><a href="index.html">메인 사이트</a></li>
            <li><a href="reservation.html">예약 페이지</a></li>
          </ul>
        </nav>

        <!-- 햄버거 메뉴 -->
        <div class="hamburger">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
    </header>

    <main class="admin-container">
      <section class="section login-section">
        <div class="container">
          <h1 class="section-title">관리자 로그인</h1>
          <p class="section-subtitle">
            Say It Gil Hotel 관리자 페이지에 접속하세요
          </p>

          <div class="login-form-container">
            <form id="loginForm" class="login-form">
              <div class="form-group">
                <label for="adminEmail">
                  <i class="fas fa-envelope"></i>
                  이메일
                </label>
                <input
                  type="email"
                  id="adminEmail"
                  name="adminEmail"
                  placeholder="관리자 이메일을 입력하세요"
                  required
                />
              </div>

              <div class="form-group">
                <label for="adminPassword">
                  <i class="fas fa-lock"></i>
                  비밀번호
                </label>
                <input
                  type="password"
                  id="adminPassword"
                  name="adminPassword"
                  placeholder="비밀번호를 입력하세요"
                  required
                />
              </div>

              <button type="submit" class="login-btn">
                <i class="fas fa-sign-in-alt"></i>
                로그인
              </button>
            </form>
          </div>
        </div>
      </section>

      <section id="adminPanel" class="section admin-panel-section hidden">
        <div class="container">
          <div class="admin-header">
            <h2 class="section-title">예약 관리</h2>
            <p class="section-subtitle">
              모든 예약 내역을 확인하고 관리할 수 있습니다
            </p>
            <button onclick="logout()" class="logout-btn">
              <i class="fas fa-sign-out-alt"></i>
              로그아웃
            </button>
          </div>

          <div class="admin-stats">
            <div class="stat-card">
              <div class="stat-icon">
                <i class="fas fa-calendar-check"></i>
              </div>
              <div class="stat-info">
                <h3 id="totalReservations">0</h3>
                <p>총 예약 수</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">
                <i class="fas fa-users"></i>
              </div>
              <div class="stat-info">
                <h3 id="totalGuests">0</h3>
                <p>총 투숙객 수</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">
                <i class="fas fa-bed"></i>
              </div>
              <div class="stat-info">
                <h3 id="activeReservations">0</h3>
                <p>활성 예약</p>
              </div>
            </div>
          </div>

          <div class="admin-table-container">
            <div class="table-header">
              <h3>예약 목록</h3>
              <div class="table-controls">
                <input
                  type="text"
                  id="searchInput"
                  placeholder="이름, 이메일로 검색..."
                  class="search-input"
                />
                <button onclick="refreshData()" class="refresh-btn">
                  <i class="fas fa-sync-alt"></i>
                  새로고침
                </button>
              </div>
            </div>

            <div class="table-wrapper">
              <table class="admin-table">
                <thead>
                  <tr>
                    <th>예약자</th>
                    <th>이메일</th>
                    <th>연락처</th>
                    <th>객실</th>
                    <th>체크인</th>
                    <th>체크아웃</th>
                    <th>인원</th>
                    <th>예약일</th>
                    <th>관리</th>
                  </tr>
                </thead>
                <tbody id="adminTable"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="footer">
      <div class="container">
        <div class="footer-content">
          <div class="footer-logo">Say It Gil Hotel 관리자</div>
          <div class="footer-links">
            <a href="index.html">메인 사이트</a> |
            <a href="reservation.html">예약 페이지</a>
          </div>
        </div>
        <p class="copyright">
          &copy; 2025 Say It Gil Hotel. All Rights Reserved.
        </p>
      </div>
    </footer>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        deleteDoc,
        doc,
        updateDoc,
      } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
      import {
        getAuth,
        signInWithEmailAndPassword,
        signOut,
      } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

      // 헤더 여백 조정
      const headerEl = document.querySelector(".header");
      const contentEl = document.querySelector(".admin-container");
      if (headerEl && contentEl)
        contentEl.style.paddingTop = headerEl.offsetHeight + 20 + "px";

      // Firebase 설정
      const firebaseConfig = {
        apiKey: "AIzaSyBcxmh2FQ8-1J8yk816XZJyiEAn-_z1Ufc",
        authDomain: "sayitgil-reservation.firebaseapp.com",
        projectId: "sayitgil-reservation",
        storageBucket: "sayitgil-reservation.appspot.com",
        messagingSenderId: "156182422109",
        appId: "1:156182422109:web:71e9b0948331f1755123b4",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      // UI 요소들
      const loginForm = document.getElementById("loginForm");
      const adminPanel = document.getElementById("adminPanel");
      const tableBody = document.getElementById("adminTable");
      const searchInput = document.getElementById("searchInput");
      const totalReservations = document.getElementById("totalReservations");
      const totalGuests = document.getElementById("totalGuests");
      const activeReservations = document.getElementById("activeReservations");

      let allReservations = [];

      // 로그인 처리
      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const loginBtn = loginForm.querySelector('button[type="submit"]');
        const originalText = loginBtn.innerHTML;

        try {
          loginBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> 로그인 중...';
          loginBtn.disabled = true;

          await signInWithEmailAndPassword(
            auth,
            loginForm.adminEmail.value,
            loginForm.adminPassword.value
          );

          loginForm.classList.add("hidden");
          adminPanel.classList.remove("hidden");
          await loadReservations();
        } catch (error) {
          alert("로그인 실패: " + error.message);
        } finally {
          loginBtn.innerHTML = originalText;
          loginBtn.disabled = false;
        }
      });

      // 로그아웃 처리
      window.logout = async () => {
        try {
          await signOut(auth);
          loginForm.classList.remove("hidden");
          adminPanel.classList.add("hidden");
          loginForm.reset();
        } catch (error) {
          console.error("로그아웃 오류:", error);
        }
      };

      // 예약 데이터 로드
      async function loadReservations() {
        try {
          const snapshot = await getDocs(collection(db, "reservations"));
          allReservations = [];

          snapshot.forEach((docSnap) => {
            const data = docSnap.data();
            allReservations.push({
              id: docSnap.id,
              ...data,
            });
          });

          updateStats();
          displayReservations(allReservations);
        } catch (error) {
          console.error("데이터 로드 오류:", error);
          alert("데이터를 불러오는 중 오류가 발생했습니다.");
        }
      }

      // 통계 업데이트
      function updateStats() {
        const total = allReservations.length;
        const guests = allReservations.reduce(
          (sum, res) => sum + (res.guests || 0),
          0
        );
        const active = allReservations.filter((res) => {
          const today = new Date().toISOString().split("T")[0];
          return res.checkout >= today;
        }).length;

        totalReservations.textContent = total;
        totalGuests.textContent = guests;
        activeReservations.textContent = active;
      }

      // 예약 목록 표시
      function displayReservations(reservations) {
        tableBody.innerHTML = "";

        if (reservations.length === 0) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="9" class="no-data">
                <i class="fas fa-inbox"></i>
                예약 데이터가 없습니다.
              </td>
            </tr>
          `;
          return;
        }

        reservations.forEach((reservation) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${reservation.name || "-"}</td>
            <td>${reservation.email || "-"}</td>
            <td>${reservation.phone || "-"}</td>
            <td>${reservation.roomTitle || "-"}</td>
            <td>${reservation.checkin || "-"}</td>
            <td>${reservation.checkout || "-"}</td>
            <td>${reservation.guests || "-"}명</td>
            <td>${
              reservation.createdAt
                ? new Date(reservation.createdAt).toLocaleDateString()
                : "-"
            }</td>
            <td class="action-buttons">
              <button class="btn-edit" onclick="editReservation('${
                reservation.id
              }')">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-delete" onclick="deleteReservation('${
                reservation.id
              }')">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          `;
          tableBody.appendChild(row);
        });
      }

      // 검색 기능
      searchInput.addEventListener("input", (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const filtered = allReservations.filter(
          (reservation) =>
            (reservation.name &&
              reservation.name.toLowerCase().includes(searchTerm)) ||
            (reservation.email &&
              reservation.email.toLowerCase().includes(searchTerm))
        );
        displayReservations(filtered);
      });

      // 새로고침 기능
      window.refreshData = async () => {
        await loadReservations();
      };

      // 예약 수정
      window.editReservation = async (id) => {
        try {
          // 해당 예약 데이터 찾기
          const reservation = allReservations.find((r) => r.id === id);
          if (!reservation) {
            alert("예약 정보를 찾을 수 없습니다.");
            return;
          }

          const name = prompt("이름", reservation.name || "");
          if (name === null) return;

          const email = prompt("이메일", reservation.email || "");
          if (email === null) return;

          const phone = prompt("전화번호", reservation.phone || "");
          if (phone === null) return;

          const whatsapp = prompt("WhatsApp ID", reservation.whatsapp || "");
          if (whatsapp === null) return;

          const checkin = prompt(
            "체크인 (YYYY-MM-DD)",
            reservation.checkin || ""
          );
          if (checkin === null) return;

          const checkout = prompt(
            "체크아웃 (YYYY-MM-DD)",
            reservation.checkout || ""
          );
          if (checkout === null) return;

          if (checkin && checkout && checkout <= checkin) {
            alert(
              "체크아웃 날짜가 체크인보다 같거나 이릅니다. 다시 확인해주세요."
            );
            return;
          }

          const guestsStr = prompt("인원 수", reservation.guests || "");
          if (guestsStr === null) return;
          const guests = Number(guestsStr);
          if (Number.isNaN(guests) || guests <= 0) {
            alert("인원 수는 1 이상의 숫자여야 합니다.");
            return;
          }

          await updateDoc(doc(db, "reservations", id), {
            name,
            email,
            emailLower: email.toLowerCase(),
            phone,
            whatsapp,
            checkin,
            checkout,
            guests,
          });

          alert("예약 정보가 수정되었습니다.");
          await loadReservations();
        } catch (err) {
          console.error("수정 오류:", err);
          alert("수정 중 오류가 발생했습니다.");
        }
      };

      // 예약 삭제
      window.deleteReservation = async (id) => {
        if (!confirm("정말 삭제하시겠습니까?")) return;
        try {
          await deleteDoc(doc(db, "reservations", id));
          alert("예약이 삭제되었습니다.");
          await loadReservations();
        } catch (err) {
          console.error("삭제 오류:", err);
          alert("삭제 중 오류가 발생했습니다.");
        }
      };
    </script>
  </body>
</html>
