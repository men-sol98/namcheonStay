<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>사잇길 숙소 예약 - Say It Gil Hotel</title>
    <link rel="stylesheet" href="assets/css/style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />

    <!-- flatpickr 스타일/스크립트 (달력) -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/rangePlugin.js"></script>

    <!-- 다국어 지원 스크립트 -->
    <script src="assets/js/i18n.js"></script>
    <script src="assets/js/script.js"></script>
  </head>
  <body>
    <header class="header">
      <div class="nav-container">
        <a href="index.html" class="logo" data-i18n="logo">사잇길(SayItGil)</a>

        <nav class="nav">
          <ul class="nav-links">
            <li>
              <a href="index.html#concept" data-i18n="nav_concept">가치</a>
            </li>
            <li>
              <a href="index.html#story" data-i18n="nav_story">마을 이야기</a>
            </li>
            <li>
              <a href="index.html#exp-program" data-i18n="nav_experience"
                >체험 프로그램</a
              >
            </li>
            <li>
              <a href="index.html#experience" data-i18n="nav_usage"
                >이용 가이드</a
              >
            </li>
            <li><a href="index.html#rooms" data-i18n="nav_rooms">객실</a></li>
          </ul>
        </nav>

        <!-- 언어 전환 버튼 -->
        <div class="lang-switch">
          <button onclick="changeLanguage('ko')">한국어</button>
          <button onclick="changeLanguage('en')">English</button>
          <button onclick="changeLanguage('jp')">日本語</button>
          <button onclick="changeLanguage('tw')">繁體中文</button>
        </div>

        <div class="hamburger"><span></span><span></span><span></span></div>
      </div>
    </header>

    <main class="reservation-container">
      <section class="section booking-section">
        <div class="container booking-grid">
          <h1 class="section-title" data-i18n="reservation_title">
            체험 프로그램 예약하기
          </h1>
          <p class="section-subtitle" data-i18n="reservation_subtitle">
            막걸리 3종 시음과 DIY 동래파전 체험 프로그램
          </p>

          <!-- 좌측: 체험 정보 -->
          <div class="room-info-card" id="experienceInfo">
            <div class="room-gallery">
              <img
                id="experienceHero"
                alt="experience hero"
                class="room-hero-image"
              />
            </div>
            <div class="room-details">
              <h2 id="experienceTitle" data-i18n="exp_title_full">
                막걸리&동래파전 체험 (1시간 코스)
              </h2>
              <div class="highlight-list">
                <p data-i18n="exp_highlight_1">
                  ✅ 1시간 완성: 바쁜 일정에 최적화된 고효율 코스 (체험+식사
                  동시 해결)
                </p>
                <p data-i18n="exp_highlight_2">
                  ✅ 핵심 구성: 전문가와 함께하는 막걸리 3종 시음 및 동래파전
                  DIY
                </p>
                <p data-i18n="exp_highlight_3">
                  ✅ 모두 환영: 비음주 고객을 위한 전통 음료 3종도 준비 완료
                </p>
                <p data-i18n="exp_highlight_4">
                  ✅ 맞춤 배려: 채식주의자를 위한 해산물 제외 파전 별도 제작
                  가능
                </p>
              </div>
              <div class="price-box">
                <strong data-i18n="exp_price_label">체험 가격 (1인당)</strong>
                <span id="pricePerPersonText">40,000 KRW</span>
              </div>
            </div>
          </div>

          <!-- 우측: 예약 폼 -->
          <div class="booking-form-container">
            <form id="reservationForm" class="booking-form">
              <div class="form-row">
                <div class="form-group">
                  <label
                    for="experienceDate"
                    class="required"
                    data-i18n="form_date"
                    >체험 날짜</label
                  >
                  <input
                    type="date"
                    id="experienceDate"
                    name="experienceDate"
                    required
                    data-i18n-placeholder="date_placeholder"
                    placeholder="연도-월-일"
                  />
                </div>
                <div class="form-group">
                  <label
                    for="experienceTime"
                    class="required"
                    data-i18n="form_time"
                    >체험 시간</label
                  >
                  <select id="experienceTime" name="experienceTime" required>
                    <option value="" data-i18n="time_select_placeholder">
                      시간을 선택해주세요
                    </option>
                    <option value="18:00">18:00</option>
                  </select>
                </div>
              </div>

              <div class="form-group">
                <label
                  for="participants"
                  class="required"
                  data-i18n="form_participants"
                  >참가인원</label
                >
                <input
                  type="number"
                  id="participants"
                  name="participants"
                  min="1"
                  max="20"
                  required
                />
                <div id="remainingHint" class="remaining-hint"></div>
              </div>

              <div class="form-group">
                <label for="repName" class="required" data-i18n="form_name"
                  >이름</label
                >
                <input type="text" id="repName" name="repName" required />
              </div>
              <div class="form-group">
                <label for="repPhone" data-i18n="form_phone">연락처</label
                ><span class="optional-tag" data-i18n="optional_tag">선택</span>
                <input type="tel" id="repPhone" name="repPhone" />
              </div>
              <div class="form-group">
                <label for="repEmail" class="required" data-i18n="form_email"
                  >이메일</label
                >
                <input type="email" id="repEmail" name="repEmail" required />
              </div>

              <div class="form-group">
                <label data-i18n="form_extra_requests">추가 요청 사항</label>
                <div class="checkbox-group">
                  <label
                    ><input type="checkbox" id="optVegetarian" />
                    <span data-i18n="opt_vegetarian"
                      >채식 옵션 요청</span
                    ></label
                  >
                  <label
                    ><input type="checkbox" id="optNonalchol" />
                    <span data-i18n="opt_Nonalchol"
                      >음료 변경 옵션 요청</span
                    ></label
                  >
                  <label
                    ><input type="checkbox" id="optPickupG" />
                    <span data-i18n="opt_pickup_g"
                      >픽업 서비스 요청(경성대역)</span
                    ></label
                  >
                  <label
                    ><input type="checkbox" id="optPickupO" />
                    <span data-i18n="opt_pickup_o"
                      >픽업 서비스 요청(오륙도)</span
                    ></label
                  >
                </div>
              </div>

              <div class="total-box">
                <div class="total-row">
                  <span class="total-label" data-i18n="final_amount"
                    >최종 결제 금액:</span
                  >
                  <strong id="totalAmountText">0 KRW</strong>
                </div>
                <button type="submit" class="booking-btn" id="submitBtn">
                  <i class="fas fa-credit-card"></i>
                  <span data-i18n="confirm_and_pay">예약하기</span>
                </button>
              </div>
            </form>

            <div id="status" class="status-message"></div>

            <div class="info-box" style="margin-top: 16px">
              <p>
                ✅
                <span data-i18n="info_email_notice"
                  >예약 접수 후 확인 메일을 발송해 드립니다. 예약 내용
                  조회/변경/취소는 회신으로 요청해 주세요.</span
                >
              </p>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="footer">
      <div class="container">
        <div class="footer-content">
          <div class="footer-logo" data-i18n="footer_logo">
            Say It Gil Hotel
          </div>
          <div class="footer-links">
            <a href="#" data-i18n="footer_privacy">개인정보처리방침</a> |
            <a href="#" data-i18n="footer_terms">이용약관</a>
          </div>
        </div>
        <p class="copyright">
          &copy; 2025 Say It Gil Hotel. All Rights Reserved.
        </p>
      </div>
    </footer>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        query,
        getDocs,
        where,
      } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

      // 헤더 높이만큼 본문 여백
      const headerEl = document.querySelector(".header");
      const contentEl = document.querySelector(".reservation-container");
      if (headerEl && contentEl)
        contentEl.style.paddingTop = headerEl.offsetHeight + 20 + "px";

      // Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyBcxmh2FQ8-1J8yk816XZJyiEAn-_z1Ufc",
        authDomain: "sayitgil-reservation.firebaseapp.com",
        projectId: "sayitgil-reservation",
        storageBucket: "sayitgil-reservation.appspot.com",
        messagingSenderId: "156182422109",
        appId: "1:156182422109:web:71e9b0948331f1755123b4",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // 가격 및 UI 요소
      const PRICE_PER_PERSON = 40000;
      const form = document.getElementById("reservationForm");
      const statusText = document.getElementById("status");
      const totalAmountText = document.getElementById("totalAmountText");
      const participantsEl = document.getElementById("participants");
      const experienceDateEl = document.getElementById("experienceDate");
      const experienceTimeEl = document.getElementById("experienceTime");
      const submitBtn = document.getElementById("submitBtn");
      const heroImg = document.getElementById("experienceHero");
      const experienceTitleEl = document.getElementById("experienceTitle");
      let currentRemaining = null; // 잔여석
      let datePicker = null; // flatpickr 인스턴스

      // 가용성 맵: time -> { enabled:Set(date), full:Set(date) }
      const availabilityByTime = new Map();
      // 어떤 시간대든 잔여석이 있는 날짜의 집합
      let availableDatesAllTimes = new Set();

      // 경험 정보 세팅
      heroImg.src = "./assets/images/experience_makgeolli.png";
      heroImg.onerror = () => (heroImg.style.display = "none");
      experienceTitleEl.textContent = "막걸리&동래파전 체험 (1시간 코스)";

      // 날짜 선택기 (단일 날짜)
      if (!window.flatpickr) console.error("flatpickr 로드 순서를 확인하세요.");
      flatpickr.localize(flatpickr.l10ns.ko);
      datePicker = flatpickr(experienceDateEl, {
        dateFormat: "Y-m-d",
        minDate: "today",
        disable: [],
      });

      // 번역 헬퍼
      function t(key, fallback = "") {
        try {
          return (
            translations[currentLanguage]?.[key] ||
            translations["ko"]?.[key] ||
            fallback
          );
        } catch {
          return fallback;
        }
      }
      function fmt(str, vars) {
        return str.replace(/\{(\w+)\}/g, (_, k) => String(vars?.[k] ?? ""));
      }

      // 로컬 날짜(YYYY-MM-DD) 포맷터 (UTC 변환 회피)
      function formatDateLocal(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, "0");
        const d = String(date.getDate()).padStart(2, "0");
        return `${y}-${m}-${d}`;
      }

      function formatKRW(amount) {
        return new Intl.NumberFormat("ko-KR").format(amount) + " KRW";
      }

      function recalcTotal() {
        const count = Number(participantsEl.value || 0);
        const total = PRICE_PER_PERSON * Math.max(0, count);
        totalAmountText.textContent = formatKRW(total);
        // 잔여석 제한 체크
        if (currentRemaining !== null) {
          if (count > currentRemaining) {
            participantsEl.value = currentRemaining;
            totalAmountText.textContent = formatKRW(
              PRICE_PER_PERSON * currentRemaining
            );
          }
          const hint = document.getElementById("remainingHint");
          if (hint) {
            if (currentRemaining <= 0) {
              hint.textContent = t(
                "hint_remaining_zero",
                "남은 정원: 0명 (예약 불가)"
              );
              hint.className = "remaining-hint danger";
            } else {
              hint.textContent = fmt(t("hint_remaining", "남은 정원: {n}명"), {
                n: currentRemaining,
              });
              hint.className = "remaining-hint";
            }
          }
        }
      }
      participantsEl.addEventListener("input", recalcTotal);
      // 달력 비활성화 적용 (선택된 시간 기준)
      function applyDisabledDatesForTime(time) {
        if (!datePicker) return;
        // 시간 선택 전: 어떤 시간대든 잔여석이 있는 날짜만 활성화
        if (!time || !availabilityByTime.has(time)) {
          const disableFnAny = (date) => {
            const ds = formatDateLocal(date);
            return !availableDatesAllTimes.has(ds);
          };
          datePicker.set("disable", [disableFnAny]);
          return;
        }
        const { enabled, full } = availabilityByTime.get(time);
        const availableForTime = new Set(
          Array.from(enabled).filter((d) => !full.has(d))
        );
        const disableFnTime = (date) => {
          const ds = formatDateLocal(date);
          return !availableForTime.has(ds);
        };
        datePicker.set("disable", [disableFnTime]);
      }

      // 가용성 로드 (스케줄/예약 합산 → 남은 정원 계산)
      async function loadAvailability() {
        try {
          const todayStr = new Date().toISOString().slice(0, 10);
          // 1) 스케줄 로드
          const scheduleSnap = await getDocs(
            collection(db, "experienceSchedules")
          );
          const scheduleMap = new Map(); // key: date__time -> maxCapacity
          const times = new Set();
          scheduleSnap.forEach((docSnap) => {
            const d = docSnap.data();
            if (!d?.date || !d?.time) return;
            times.add(d.time);
            scheduleMap.set(`${d.date}__${d.time}`, Number(d.maxCapacity || 0));
          });

          // 2) 해당 스케줄 범위의 예약 로드 (미래 위주)
          const rSnap = await getDocs(
            query(
              collection(db, "reservations"),
              where("type", "==", "experience")
            )
          );
          const bookedMap = new Map(); // key: date__time -> sum
          rSnap.forEach((docSnap) => {
            const r = docSnap.data();
            const key = `${r.experienceDate}__${r.experienceTime}`;
            if (!r.experienceDate || !r.experienceTime) return;
            const prev = bookedMap.get(key) || 0;
            bookedMap.set(key, prev + Number(r.participants || 0));
          });

          // 3) 시간별 가능/만석 날짜 집계
          availabilityByTime.clear();
          availableDatesAllTimes = new Set();
          times.forEach((time) => {
            availabilityByTime.set(time, {
              enabled: new Set(),
              full: new Set(),
            });
          });
          scheduleMap.forEach((maxCap, key) => {
            const [date, time] = key.split("__");
            const booked = bookedMap.get(key) || 0;
            const remaining = Math.max(
              0,
              Number(maxCap || 0) - Number(booked || 0)
            );
            const entry = availabilityByTime.get(time) || {
              enabled: new Set(),
              full: new Set(),
            };
            entry.enabled.add(date);
            if (remaining === 0) entry.full.add(date);
            availabilityByTime.set(time, entry);
            if (remaining > 0) availableDatesAllTimes.add(date);
          });

          // 현재 선택된 시간 기준으로 달력 비활성화 적용
          applyDisabledDatesForTime(experienceTimeEl.value);
        } catch (e) {
          console.error("가용성 로드 오류:", e);
        }
      }

      // 최초 가용성 로드
      loadAvailability();

      // 날짜/시간 선택 시 잔여석 조회
      async function fetchRemaining() {
        statusText.textContent = "";
        currentRemaining = null;
        const date = experienceDateEl.value;
        const time = experienceTimeEl.value;
        if (!date || !time) return;

        try {
          // 1) 스케줄 조회
          const scheduleQ = query(
            collection(db, "experienceSchedules"),
            where("date", "==", date),
            where("time", "==", time)
          );
          const scheduleSnap = await getDocs(scheduleQ);
          if (scheduleSnap.empty) {
            statusText.textContent =
              "선택한 일자의 체험이 아직 준비되지 않았습니다.";
            statusText.className = "status-message error";
            currentRemaining = 0;
            return;
          }
          let maxCapacity = 0;
          scheduleSnap.forEach(
            (d) => (maxCapacity = Number(d.data().maxCapacity) || 0)
          );

          // 2) 해당 날짜/시간 예약 인원 합산
          const rQ = query(
            collection(db, "reservations"),
            where("type", "==", "experience"),
            where("experienceDate", "==", date),
            where("experienceTime", "==", time)
          );
          const rSnap = await getDocs(rQ);
          let booked = 0;
          rSnap.forEach((docSnap) => {
            const d = docSnap.data();
            booked += Number(d.participants || 0);
          });

          currentRemaining = Math.max(0, maxCapacity - booked);
          // 입력 제한
          participantsEl.max = String(currentRemaining);
          if (!participantsEl.value || Number(participantsEl.value) === 0) {
            participantsEl.value = currentRemaining > 0 ? 1 : 0;
          } else if (Number(participantsEl.value) > currentRemaining) {
            participantsEl.value = currentRemaining;
          }

          // 안내 출력
          if (currentRemaining <= 0) {
            statusText.className = "status-message error";
            statusText.textContent = "해당 시간은 정원이 가득 찼습니다.";
            submitBtn.disabled = true;
          } else {
            statusText.className = "status-message success";
            statusText.textContent = `남은 정원: ${currentRemaining}명`;
            submitBtn.disabled = false;
          }
          const hint = document.getElementById("remainingHint");
          if (hint) {
            if (currentRemaining <= 0) {
              hint.textContent = t(
                "hint_remaining_zero",
                "남은 정원: 0명 (예약 불가)"
              );
              hint.className = "remaining-hint danger";
            } else {
              hint.textContent = fmt(t("hint_remaining", "남은 정원: {n}명"), {
                n: currentRemaining,
              });
              hint.className = "remaining-hint";
            }
          }
          recalcTotal();
        } catch (e) {
          console.error("잔여석 조회 오류:", e);
          statusText.className = "status-message error";
          statusText.textContent = "잔여석 조회 중 오류가 발생했습니다.";
        }
      }

      experienceDateEl.addEventListener("change", fetchRemaining);
      experienceTimeEl.addEventListener("change", () => {
        applyDisabledDatesForTime(experienceTimeEl.value);
        fetchRemaining();
      });
      recalcTotal();

      // 제출
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        submitBtn.disabled = true;
        statusText.textContent = "";

        const data = {
          type: "experience",
          experienceTitle: experienceTitleEl.textContent,
          experienceDate: form.experienceDate.value,
          experienceTime: form.experienceTime.value,
          participants: Number(form.participants.value),
          repName: form.repName.value,
          repPhone: form.repPhone.value || "",
          repEmail: form.repEmail.value,
          optVegetarian: document.getElementById("optVegetarian").checked,
          optPickupG: document.getElementById("optPickupG").checked,
          optPickupO: document.getElementById("optPickupO").checked,
          pricePerPerson: PRICE_PER_PERSON,
          totalAmount: PRICE_PER_PERSON * Number(form.participants.value || 0),
          createdAt: new Date().toISOString(),
        };

        // 최종 잔여석 재검증
        await fetchRemaining();
        if (currentRemaining === null || currentRemaining <= 0) {
          alert("해당 시간은 예약할 수 없습니다.");
          submitBtn.disabled = false;
          return;
        }
        if (data.participants > currentRemaining) {
          alert(`남은 정원(${currentRemaining}명)을 초과했습니다.`);
          submitBtn.disabled = false;
          return;
        }

        try {
          await addDoc(collection(db, "reservations"), data);
          statusText.textContent =
            translations[currentLanguage]?.msg_success ||
            "예약이 접수되었습니다.";
          statusText.className = "status-message success";
          form.reset();
          recalcTotal();
        } catch (err) {
          console.error("예약 오류:", err);
          statusText.textContent =
            translations[currentLanguage]?.msg_error ||
            "예약 중 오류가 발생했습니다.";
          statusText.className = "status-message error";
        } finally {
          submitBtn.disabled = false;
        }
      });
    </script>
  </body>
</html>
