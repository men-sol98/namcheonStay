<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì‚¬ì‡ê¸¸ ìˆ™ì†Œ ì˜ˆì•½ - Say It Gil Hotel</title>
    <link rel="stylesheet" href="assets/css/style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />

    <!-- flatpickr ìŠ¤íƒ€ì¼/ìŠ¤í¬ë¦½íŠ¸ (ë‹¬ë ¥) -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/rangePlugin.js"></script>

    <!-- ë‹¤êµ­ì–´ ì§€ì› ìŠ¤í¬ë¦½íŠ¸ -->
    <script src="assets/js/i18n.js"></script>
    <script src="assets/js/script.js"></script>
  </head>
  <body>
    <header class="header">
      <div class="nav-container">
        <a href="index.html" class="logo" data-i18n="logo">ì‚¬ì‡ê¸¸(SayItGil)</a>

        <nav class="nav">
          <ul class="nav-links">
            <li>
              <a href="index.html#concept" data-i18n="nav_concept">ê°€ì¹˜</a>
            </li>
            <li>
              <a href="index.html#story" data-i18n="nav_story">ë§ˆì„ ì´ì•¼ê¸°</a>
            </li>
            <li>
              <a href="index.html#experience" data-i18n="nav_usage"
                >ì´ìš© ê°€ì´ë“œ</a
              >
            </li>
            <li>
              <a href="index.html#exp-program" data-i18n="nav_experience"
                >ì²´í—˜ í”„ë¡œê·¸ë¨</a
              >
            </li>
            <li><a href="index.html#rooms" data-i18n="nav_rooms">ê°ì‹¤</a></li>
          </ul>
        </nav>

        <!-- ì–¸ì–´ ì „í™˜ ë²„íŠ¼ -->
        <div class="lang-switch">
          <button onclick="changeLanguage('ko')">í•œêµ­ì–´</button>
          <button onclick="changeLanguage('en')">English</button>
          <button onclick="changeLanguage('jp')">æ—¥æœ¬èª</button>
          <button onclick="changeLanguage('tw')">ç¹é«”ä¸­æ–‡</button>
        </div>

        <div class="hamburger"><span></span><span></span><span></span></div>
      </div>
    </header>

    <main class="reservation-container">
      <section class="section booking-section">
        <div class="container booking-grid">
          <h1 class="section-title" data-i18n="reservation_title">
            ìˆ™ì†Œ ì˜ˆì•½í•˜ê¸°
          </h1>
          <p class="section-subtitle" data-i18n="reservation_subtitle">
            Say It Gil Hotelì—ì„œ íŠ¹ë³„í•œ ì—¬í–‰ì„ ì‹œì‘í•˜ì„¸ìš”
          </p>

          <!-- ë°© ì •ë³´ -->
          <div class="room-info-card">
            <div class="room-gallery">
              <img id="roomHero" alt="room hero" class="room-hero-image" />
            </div>
            <div class="room-details">
              <h2 id="roomTitle" data-i18n="room_selected">ì„ íƒëœ ê°ì‹¤</h2>
              <p id="roomDescription" data-i18n="room_description">
                ì•„ë¦„ë‹¤ìš´ ì „ë§ê³¼ í¸ì•ˆí•œ ì‹œì„¤ì„ ê°–ì¶˜ ê°ì‹¤ì…ë‹ˆë‹¤.
              </p>
            </div>
          </div>

          <!-- ì˜ˆì•½ í¼ -->
          <div class="booking-form-container">
            <form id="reservationForm" class="booking-form">
              <div class="form-group">
                <label for="name" class="required" data-i18n="form_name"
                  >ì´ë¦„</label
                >
                <input type="text" id="name" name="name" required />
              </div>

              <div class="form-group">
                <label for="email" class="required" data-i18n="form_email"
                  >ì´ë©”ì¼</label
                >
                <input type="email" id="email" name="email" required />
              </div>

              <div class="form-group">
                <label for="phone" data-i18n="form_phone">ì „í™”ë²ˆí˜¸</label
                ><span class="optional-tag" data-i18n="optional_tag">ì„ íƒ</span>
                <input type="tel" id="phone" name="phone" />
              </div>

              <div class="form-group">
                <label for="whatsapp" data-i18n="form_whatsapp"
                  >WhatsApp ID</label
                >
                <input type="text" id="whatsapp" name="whatsapp" />
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="checkin" class="required" data-i18n="form_checkin"
                    >ì²´í¬ì¸ ë‚ ì§œ</label
                  >
                  <input
                    type="date"
                    id="checkin"
                    name="checkin"
                    required
                    data-i18n-placeholder="date_placeholder"
                    placeholder="ì—°ë„-ì›”-ì¼"
                  />
                </div>

                <div class="form-group">
                  <label
                    for="checkout"
                    class="required"
                    data-i18n="form_checkout"
                    >ì²´í¬ì•„ì›ƒ ë‚ ì§œ</label
                  >
                  <input
                    type="date"
                    id="checkout"
                    name="checkout"
                    required
                    data-i18n-placeholder="date_placeholder"
                    placeholder="ì—°ë„-ì›”-ì¼"
                  />
                </div>
              </div>

              <div class="form-group">
                <label for="guests" class="required" data-i18n="form_guests"
                  >ì¸ì› ìˆ˜</label
                >
                <input
                  type="number"
                  id="guests"
                  name="guests"
                  min="1"
                  max="6"
                  required
                />
              </div>

              <button type="submit" class="booking-btn" data-i18n="form_submit">
                <i class="fas fa-calendar-check"></i>
                ì˜ˆì•½í•˜ê¸°
              </button>
            </form>

            <div id="status" class="status-message"></div>

            <!-- ì•ˆë‚´ ë°•ìŠ¤: ì¡°íšŒ/ìˆ˜ì •/ì·¨ì†ŒëŠ” ì´ë©”ì¼ë¡œ -->
            <div class="info-box" style="margin-top: 16px">
              <p>
                âœ… ì˜ˆì•½ ì ‘ìˆ˜ í›„ í™•ì¸ ë©”ì¼ì„ ë°œì†¡í•´ ë“œë¦½ë‹ˆë‹¤. <br />
                ì˜ˆì•½ ë‚´ìš© ì¡°íšŒ/ë³€ê²½/ì·¨ì†Œê°€ í•„ìš”í•˜ì‹œë©´, ì ‘ìˆ˜ëœ ì´ë©”ì¼ë¡œ íšŒì‹ í•´
                ì£¼ì„¸ìš”.
              </p>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="footer">
      <div class="container">
        <div class="footer-content">
          <div class="footer-logo" data-i18n="footer_logo">
            Say It Gil Hotel
          </div>
          <div class="footer-links">
            <a href="#" data-i18n="footer_privacy">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a> |
            <a href="#" data-i18n="footer_terms">ì´ìš©ì•½ê´€</a>
          </div>
        </div>
        <p class="copyright">
          &copy; 2025 Say It Gil Hotel. All Rights Reserved.
        </p>
      </div>
    </footer>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        query,
        getDocs,
        where,
      } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

      // í—¤ë” ë†’ì´ë§Œí¼ ë³¸ë¬¸ ì—¬ë°±
      const headerEl = document.querySelector(".header");
      const contentEl = document.querySelector(".reservation-container");
      if (headerEl && contentEl)
        contentEl.style.paddingTop = headerEl.offsetHeight + 20 + "px";

      // Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyBcxmh2FQ8-1J8yk816XZJyiEAn-_z1Ufc",
        authDomain: "sayitgil-reservation.firebaseapp.com",
        projectId: "sayitgil-reservation",
        storageBucket: "sayitgil-reservation.appspot.com",
        messagingSenderId: "156182422109",
        appId: "1:156182422109:web:71e9b0948331f1755123b4",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // ë°© íŒŒë¼ë¯¸í„°
      const params = new URLSearchParams(location.search);
      const roomId = params.get("room") || "room1";
      const roomTitle = params.get("title") || "ìˆ™ì†Œ ì˜ˆì•½í•˜ê¸°";

      // UI ìš”ì†Œ
      const roomTitleEl = document.getElementById("roomTitle");
      const roomDescriptionEl = document.getElementById("roomDescription");
      const hero = document.getElementById("roomHero");
      const form = document.getElementById("reservationForm");
      const statusText = document.getElementById("status");
      const checkinEl = document.getElementById("checkin");
      const checkoutEl = document.getElementById("checkout");
      const submitBtn = form.querySelector('button[type="submit"]');

      // ë°© ì •ë³´
      roomTitleEl.textContent = roomTitle;
      hero.src = `./assets/images/rooms/${roomId}-1.png`;
      hero.onerror = () => (hero.style.display = "none");
      const roomDescriptions = {
        room1: "ì‹œì›í•œ ë°”ë‹¤ë¥¼ í•œëˆˆì— ë‹´ì„ ìˆ˜ ìˆëŠ” ê°ì‹¤ì…ë‹ˆë‹¤.",
        room2: "ì•„ë¦„ë‹¤ìš´ ì •ì›ì´ ë³´ì´ëŠ” ì•„ëŠ‘í•œ ê°ì‹¤ì…ë‹ˆë‹¤.",
        room3: "ì†Œë°•í•˜ê³  ì •ê²¨ìš´ ë§ˆì„ ì „ê²½ì„ ì¦ê¸¸ ìˆ˜ ìˆëŠ” ê°ì‹¤ì…ë‹ˆë‹¤.",
        experience: "ë§‰ê±¸ë¦¬Â·ë™ë˜íŒŒì „ ì²´í—˜ í”„ë¡œê·¸ë¨ ì˜ˆì•½ì…ë‹ˆë‹¤.",
      };
      roomDescriptionEl.textContent =
        roomDescriptions[roomId] || roomDescriptions.experience;

      // ë‚ ì§œ ìœ í‹¸
      const pad = (n) => String(n).padStart(2, "0");
      const toLocalDate = (y, m, d) => `${y}-${pad(m)}-${pad(d)}`;
      const toDateLocal = (iso) => {
        const [y, m, d] = iso.split("-").map(Number);
        return new Date(y, m - 1, d);
      };
      const dayBeforeLocal = (iso) => {
        const dt = toDateLocal(iso);
        dt.setDate(dt.getDate() - 1);
        return toLocalDate(dt.getFullYear(), dt.getMonth() + 1, dt.getDate());
      };
      const isOverlap = (aStart, aEnd, bStart, bEnd) =>
        aStart < bEnd && bStart < aEnd;

      // ê¸°ì¡´ ì˜ˆì•½ ë¡œë“œ â†’ ê²¹ì¹˜ëŠ” ë‚ ì§œ ë¹„í™œì„±í™”
      let bookedRanges = [];
      await loadBookedRanges();

      async function loadBookedRanges() {
        bookedRanges = [];
        try {
          const q = query(
            collection(db, "reservations"),
            where("roomId", "==", roomId)
          );
          const snap = await getDocs(q);
          snap.forEach((docSnap) => {
            const d = docSnap.data();
            if (d.checkin && d.checkout)
              bookedRanges.push({ start: d.checkin, end: d.checkout });
          });
        } catch (e) {
          console.error("ì˜ˆì•½ êµ¬ê°„ ë¡œë“œ ì˜¤ë¥˜:", e);
          // ì¡°ìš©íˆ ì˜¤ë¥˜ ì²˜ë¦¬ (ì‚¬ìš©ìì—ê²Œ ë¶ˆí•„ìš”í•œ ì•Œë¦¼ ë°©ì§€)
        }
      }

      // flatpickr ì´ˆê¸°í™” (checkinë§Œ)
      if (!window.flatpickr) console.error("flatpickr ë¡œë“œ ìˆœì„œë¥¼ í™•ì¸í•˜ì„¸ìš”.");
      flatpickr.localize(flatpickr.l10ns.ko);
      const disabled = bookedRanges.map((r) => ({
        from: r.start,
        to: dayBeforeLocal(r.end),
      }));

      const ciFp = flatpickr(checkinEl, {
        dateFormat: "Y-m-d",
        minDate: "today",
        disable: disabled,
        plugins: [new rangePlugin({ input: "#checkout" })],
        onChange: () => validateNoOverlap(),
      });

      function validateNoOverlap() {
        statusText.textContent = "";
        submitBtn.disabled = false;
        const ci = checkinEl.value,
          co = checkoutEl.value;
        if (!ci || !co) return true;

        const aStart = toDateLocal(ci),
          aEnd = toDateLocal(co);
        if (aEnd <= aStart) {
          statusText.textContent =
            "ì²´í¬ì•„ì›ƒ ë‚ ì§œê°€ ì²´í¬ì¸ë³´ë‹¤ ê°™ê±°ë‚˜ ë¹ ë¦…ë‹ˆë‹¤.";
          submitBtn.disabled = true;
          return false;
        }
        for (const r of bookedRanges) {
          const bStart = toDateLocal(r.start),
            bEnd = toDateLocal(r.end);
          if (isOverlap(aStart, aEnd, bStart, bEnd)) {
            statusText.textContent = `í•´ë‹¹ ê¸°ê°„ì€ ì´ë¯¸ ì˜ˆì•½ë˜ì–´ ìˆìŠµë‹ˆë‹¤. (${r.start} ~ ${r.end} ì „ê¹Œì§€)`;
            submitBtn.disabled = true;
            return false;
          }
        }
        return true;
      }

      // ì œì¶œ (ì¡°íšŒ/ìˆ˜ì • UI ì—†ìŒ)
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!validateNoOverlap()) return;

        const data = {
          roomId,
          roomTitle,
          name: form.name.value,
          email: form.email.value,
          emailLower: form.email.value.toLowerCase(),
          phone: form.phone.value || "",
          whatsapp: form.whatsapp.value || "",
          checkin: checkinEl.value,
          checkout: checkoutEl.value,
          guests: Number(form.guests.value),
          createdAt: new Date().toISOString(),
        };

        try {
          await addDoc(collection(db, "reservations"), data);
          statusText.textContent =
            "ì˜ˆì•½ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ‰ í™•ì¸ ë©”ì¼ì„ ê³§ ë³´ë‚´ë“œë¦´ê²Œìš”.";
          statusText.className = "status-message success";
          form.reset();

          // ë°©ê¸ˆ ì˜ˆì•½í•œ êµ¬ê°„ ì¦‰ì‹œ ë¹„í™œì„±í™” ë°˜ì˜
          bookedRanges.push({ start: data.checkin, end: data.checkout });
          ciFp.set("disable", [
            ...ciFp.config.disable,
            { from: data.checkin, to: dayBeforeLocal(data.checkout) },
          ]);
        } catch (err) {
          console.error("ì˜ˆì•½ ì˜¤ë¥˜:", err);
          statusText.textContent = "ì˜ˆì•½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤ ğŸ˜¢";
          statusText.className = "status-message error";
        }
      });
    </script>
  </body>
</html>
